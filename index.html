<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Ami Staff Map</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<style>
		body {
			margin: 0;
		}

		img.workoften {
			filter: hue-rotate(150deg);
		}
		img.worksometimes {
			filter: hue-rotate(150deg) saturate(0.5) brightness(1.5);
		}
		img.homesometimes {
			filter: saturate(0.5) brightness(1.5);
		}
		
		#legend {
			position: absolute;
			bottom: 20px;
			left: 20px;
			background: rgba(255, 255, 255, 0.9);
			padding: 15px;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			font-family: Arial, sans-serif;
			font-size: 14px;
			line-height: 1.4;
			z-index: 1000;
			min-width: 200px;
		}
		
		#legend h4 {
			margin: 0 0 10px 0;
			font-size: 16px;
			font-weight: bold;
			color: #333;
		}
		
		.legenditem {
			display: flex;
			align-items: center;
			margin-bottom: 8px;
			color: #333;
		}
		
		.legenditem:last-child {
			margin-bottom: 0;
		}
		
		#legend img {
			height: 20px;
			margin-right: 10px;
			flex-shrink: 0;
		}
	</style>
</head>
<body>
	<div id="map" style="height:100vh"></div>
	<div id="legend">
		<h4>Légende</h4>
		<div class="legenditem">
			<img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png">
			Où j'habite souvent
		</div>
		<div class="legenditem">
			<img class="homesometimes" src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png">
			Où j'habite parfois
		</div>
		<div class="legenditem">
			<img class="workoften" src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png">
			Ou je vais souvent travailler
		</div>
		<div class="legenditem">
			<img class="worksometimes" src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png">
			Ou je vais travailler parfois
		</div>
	</div>
	<script>
		// Function to initialize the map and load CSV data
		async function initializeApp() {
			
			const homeOften=[
			"rue paul Escudier 75009 Paris",
			"Trouville-sur-mer",
			"75013",
			"Issy-Les-Moulineaux",
			"Saint-Pierre-de-Frugie",
			"Rennes",
			"Valence"
			];
			
			const homeSometimes=[
			"rue des Chaumonts 02310 Saulchery",
			];
			
			const workOften=[
			"20 avenue de Ségur 75007 Paris",
			"26 rue Desaix 75015 Paris",
			];
			
			const workSometimes=[
			"14 avenue Ledry Rollin 75012 Paris",
			];
			
			// Initialize the map
			const map = L.map('map').setView([48.86, 2.35], 12);
			L.tileLayer(
			'https://data.geopf.fr/wmts?' +
			'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2' +
			'&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/png',
			{ attribution: '© IGN-Géoplateforme', maxZoom: 19, tileSize: 256 }
			).addTo(map);
			
			const markers = L.featureGroup().addTo(map);

			await addMarkersFrom(homeSometimes, markers, 'homesometimes');
			await addMarkersFrom(workSometimes, markers, 'worksometimes');
			await addMarkersFrom(workOften, markers, 'workoften');
			await addMarkersFrom(homeOften, markers, 'homeoften');

			if (markers.getLayers().length) {
				map.fitBounds(markers.getBounds().pad(0.2));
				//console.log(`Successfully added ${markers.getLayers().length} markers to the map`);
			}
		}
		
		async function geocodeOne(text){
			await new Promise(r => setTimeout(r, 100)); // ~10 req/s pour rester large
			const url = 'https://data.geopf.fr/geocodage/search?limit=1&q=' + encodeURIComponent(text);
			const r = await fetch(url); if(!r.ok) return null;
			const j = await r.json();
			return j.features && j.features[0] ? j.features[0] : null;
		}

		async function addMarkersFrom(data, markers, className){
			for (const addr of data) {
				const feat = await geocodeOne(addr);
				if (feat) {
					const [lon, lat] = feat.geometry.coordinates;
					L.marker([lat, lon], {icon: new L.Icon.Default({className: className})}).addTo(markers)//.bindPopup(addr);
				}
			}
		}
		
		// Initialize the app when the page loads
		window.addEventListener('load', initializeApp);
		
	</script>
</body>
</html>
