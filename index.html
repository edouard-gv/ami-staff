<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ami Staff Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div id="map" style="height:80vh"></div>
    <script>
// Function to initialize the map and load CSV data
async function initializeApp() {
  // Initialize the map
  const map = L.map('map').setView([48.86, 2.35], 12);
  L.tileLayer(
    'https://data.geopf.fr/wmts?' +
    'SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2' +
    '&STYLE=normal&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=image/png',
    { attribution: '© IGN-Géoplateforme', maxZoom: 19, tileSize: 256 }
  ).addTo(map);

  // Load and process the CSV file
  try {
    const response = await fetch('./list.csv');
    if (!response.ok) {
      throw new Error(`Failed to load CSV file: ${response.status}`);
    }
    const csvText = await response.text();
    
    Papa.parse(csvText, {
      header: true,
      skipEmptyLines: true,
      complete: async ({ data }) => {
        const markers = L.featureGroup().addTo(map);
        console.log(`Processing ${data.length} rows from CSV file`);
        
        for (const row of data) {
          const addr = row.adresse || row.address || row['adresse_complete'];
          if (!addr) continue;
          
          const feat = await geocodeOne(addr);
          if (feat) {
            const [lon, lat] = feat.geometry.coordinates;
            L.marker([lat, lon]).addTo(markers).bindPopup(addr);
            await new Promise(r => setTimeout(r, 40)); // ~25 req/s pour rester large
          }
        }
        
        if (markers.getLayers().length) {
          map.fitBounds(markers.getBounds().pad(0.2));
          console.log(`Successfully added ${markers.getLayers().length} markers to the map`);
        }
      }
    });
  } catch (error) {
    console.error('Error loading CSV file:', error);
    alert('Error loading CSV file. Please make sure ./list.csv exists and is accessible.');
  }
}

async function geocodeOne(text){
  const url = 'https://data.geopf.fr/geocodage/search?limit=1&q=' + encodeURIComponent(text);
  const r = await fetch(url); if(!r.ok) return null;
  const j = await r.json();
  return j.features && j.features[0] ? j.features[0] : null;
}

// Initialize the app when the page loads
window.addEventListener('load', initializeApp);

// Alternative: You can also use DOMContentLoaded if you prefer faster initialization
// document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
